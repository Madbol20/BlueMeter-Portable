<UserControl
    x:Class="BlueMeter.WPF.Views.EnhancedSkillBreakdownView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:BlueMeter.WPF.ViewModels"
    xmlns:oxy="http://oxyplot.org/wpf"
    d:DataContext="{d:DesignInstance Type=vm:EnhancedSkillBreakdownViewModel}"
    d:DesignHeight="800"
    d:DesignWidth="1200"
    Background="#1E1E1E"
    mc:Ignorable="d">

    <UserControl.Resources>
        <Style x:Key="DarkCard" TargetType="Border">
            <Setter Property="Background" Value="#2D2D30" />
            <Setter Property="BorderBrush" Value="#3F3F46" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="6" />
            <Setter Property="Padding" Value="16" />
            <Setter Property="Margin" Value="8" />
        </Style>

        <Style x:Key="StatLabel" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#CCCCCC" />
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Margin" Value="0,0,0,4" />
        </Style>

        <Style x:Key="StatValue" TargetType="TextBlock">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="FontSize" Value="18" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>

        <Style x:Key="SectionHeader" TargetType="TextBlock">
            <Setter Property="Foreground" Value="White" />
            <Setter Property="FontSize" Value="16" />
            <Setter Property="FontWeight" Value="Bold" />
            <Setter Property="Margin" Value="0,0,0,12" />
        </Style>

        <!--  Dark ComboBox Style  -->
        <Style x:Key="DarkComboBox" TargetType="ComboBox">
            <Setter Property="Background" Value="#3F3F46" />
            <Setter Property="Foreground" Value="White" />
            <Setter Property="BorderBrush" Value="#555555" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="8,6" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="ItemContainerStyle">
                <Setter.Value>
                    <Style TargetType="ComboBoxItem">
                        <Setter Property="Background" Value="#3F3F46" />
                        <Setter Property="Foreground" Value="White" />
                        <Setter Property="Padding" Value="8,6" />
                        <Style.Triggers>
                            <Trigger Property="IsHighlighted" Value="True">
                                <Setter Property="Background" Value="#007ACC" />
                                <Setter Property="Foreground" Value="White" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="#007ACC" />
                                <Setter Property="Foreground" Value="White" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" HorizontalScrollBarVisibility="Disabled">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!--  Header with Player Selection  -->
        <Border
            Grid.Row="0"
            Padding="16,12"
            Background="#252526"
            BorderBrush="#3F3F46"
            BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <TextBlock
                    VerticalAlignment="Center"
                    FontSize="13"
                    Foreground="#CCCCCC"
                    Text="Player:" />
                <ComboBox
                    Width="200"
                    Margin="8,0,0,0"
                    ItemsSource="{Binding AvailablePlayers}"
                    SelectedItem="{Binding SelectedPlayer}"
                    Style="{StaticResource DarkComboBox}">
                    <ComboBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding PlayerName}" Foreground="White" />
                        </DataTemplate>
                    </ComboBox.ItemTemplate>
                </ComboBox>
                <TextBlock
                    Margin="16,0,0,0"
                    VerticalAlignment="Center"
                    FontSize="18"
                    FontWeight="Bold"
                    Foreground="White"
                    Text="{Binding SelectedPlayer.PlayerName, StringFormat='Skill Breakdown - {0}'}" />

                <!--  Data Source Indicator  -->
                <StackPanel Orientation="Horizontal" Margin="32,0,0,0" VerticalAlignment="Center">
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="13"
                        Foreground="#CCCCCC"
                        Text="Data Source:"
                        Margin="0,0,8,0"/>
                    <TextBlock
                        VerticalAlignment="Center"
                        FontSize="13"
                        FontWeight="Bold"
                        Foreground="#4CAF50"
                        Text="{Binding BsonStatusText}"
                        ToolTip="Historical encounters automatically load from BSON files (if available) or fallback to SQL database" />
                </StackPanel>
            </StackPanel>
        </Border>

        <!--  Summary Stats Cards  -->
        <Grid Grid.Row="1" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Damage Card  -->
            <Border Grid.Column="0" Style="{StaticResource DarkCard}">
                <StackPanel>
                    <TextBlock Style="{StaticResource SectionHeader}" Text="ðŸ’¥ Damage Info" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Total Damage:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding TotalDamage, StringFormat='{}{0:N0}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="DPS:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding Dps, StringFormat='{}{0:N0}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Hit Count:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding TotalHits, StringFormat='{}{0:N0}'}" />
                </StackPanel>
            </Border>

            <!--  Crit Card  -->
            <Border Grid.Column="1" Style="{StaticResource DarkCard}">
                <StackPanel>
                    <TextBlock Style="{StaticResource SectionHeader}" Text="âš¡ Critical Hits" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Crit Rate:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding CritRate, StringFormat='{}{0:P1}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Crit Count:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding CritCount, StringFormat='{}{0:N0}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Crit Damage:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding TotalCritDamage, StringFormat='{}{0:N0}'}" />
                </StackPanel>
            </Border>

            <!--  Lucky Hits Card (NEW!)  -->
            <Border Grid.Column="2" Style="{StaticResource DarkCard}">
                <StackPanel>
                    <TextBlock Style="{StaticResource SectionHeader}" Text="âœ¨ Lucky Hits" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Lucky Rate:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding LuckyRate, StringFormat='{}{0:P1}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Lucky Count:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding LuckyCount, StringFormat='{}{0:N0}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Lucky Damage:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding TotalLuckyDamage, StringFormat='{}{0:N0}'}" />
                </StackPanel>
            </Border>

            <!--  Distribution Card  -->
            <Border Grid.Column="3" Style="{StaticResource DarkCard}">
                <StackPanel>
                    <TextBlock Style="{StaticResource SectionHeader}" Text="ðŸ“Š Distribution" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Normal Damage:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding NormalDamage, StringFormat='{}{0:N0}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Avg Per Hit:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding AvgDamage, StringFormat='{}{0:N0}'}" />
                    <TextBlock Style="{StaticResource StatLabel}" Text="Duration:" />
                    <TextBlock Style="{StaticResource StatValue}" Text="{Binding Duration}" />
                </StackPanel>
            </Border>
        </Grid>

        <!--  Main Content: Charts and Table  -->
        <Grid Grid.Row="2" Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="350" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Left: Charts  -->
            <StackPanel Grid.Column="0">
                <!--  Skill Pie Chart  -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource SectionHeader}" Text="ðŸŽ¯ Skill Distribution" />
                        <oxy:PlotView
                            Height="300"
                            Model="{Binding SkillPieChartModel}"
                            Background="#1E1E1E" />
                    </StackPanel>
                </Border>

                <!--  Damage Type Bar Chart  -->
                <Border Style="{StaticResource DarkCard}">
                    <StackPanel>
                        <TextBlock Style="{StaticResource SectionHeader}" Text="ðŸ”¥ Damage Distribution" />
                        <oxy:PlotView
                            Height="250"
                            Model="{Binding DamageDistributionChartModel}"
                            Background="#1E1E1E" />
                    </StackPanel>
                </Border>
            </StackPanel>

            <!--  Right: Detailed Skill Table  -->
            <Border Grid.Column="1" Style="{StaticResource DarkCard}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock
                        Grid.Row="0"
                        Style="{StaticResource SectionHeader}"
                        Text="âš”ï¸ Detailed Skill Breakdown" />

                    <DataGrid
                        Grid.Row="1"
                        AutoGenerateColumns="False"
                        Background="#1E1E1E"
                        BorderBrush="#3F3F46"
                        BorderThickness="1"
                        CanUserAddRows="False"
                        Foreground="White"
                        GridLinesVisibility="Horizontal"
                        HeadersVisibility="Column"
                        HorizontalGridLinesBrush="#3F3F46"
                        ItemsSource="{Binding SkillDetails}"
                        RowBackground="#2D2D30"
                        AlternatingRowBackground="#252526">
                        <DataGrid.ColumnHeaderStyle>
                            <Style TargetType="DataGridColumnHeader">
                                <Setter Property="Background" Value="#3F3F46" />
                                <Setter Property="Foreground" Value="White" />
                                <Setter Property="FontWeight" Value="Bold" />
                                <Setter Property="Padding" Value="8,4" />
                            </Style>
                        </DataGrid.ColumnHeaderStyle>
                        <DataGrid.Columns>
                            <DataGridTextColumn
                                Width="*"
                                Binding="{Binding SkillName}"
                                Header="Skill Name" />
                            <DataGridTextColumn
                                Width="100"
                                Binding="{Binding TotalDamage, StringFormat='{}{0:N0}'}"
                                Header="Total Damage" />
                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding DPS, StringFormat='{}{0:N0}'}"
                                Header="DPS" />
                            <DataGridTextColumn
                                Width="70"
                                Binding="{Binding HitCount, StringFormat='{}{0:N0}'}"
                                Header="Hits" />
                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding CritRate, StringFormat='{}{0:P1}'}"
                                Header="Crit %" />
                            <DataGridTextColumn
                                Width="70"
                                Binding="{Binding CritCount, StringFormat='{}{0:N0}'}"
                                Header="Crits" />
                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding LuckyRate, StringFormat='{}{0:P1}'}"
                                Header="Lucky %" />
                            <DataGridTextColumn
                                Width="70"
                                Binding="{Binding LuckyCount, StringFormat='{}{0:N0}'}"
                                Header="Lucky" />
                            <DataGridTextColumn
                                Width="90"
                                Binding="{Binding AvgPerHit, StringFormat='{}{0:N0}'}"
                                Header="Avg/Hit" />
                            <DataGridTextColumn
                                Width="80"
                                Binding="{Binding Percentage, StringFormat='{}{0:P1}'}"
                                Header="%" />
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Border>
        </Grid>
    </Grid>
    </ScrollViewer>
</UserControl>
