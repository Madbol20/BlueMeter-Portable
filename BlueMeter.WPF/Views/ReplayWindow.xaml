<Window
    x:Class="BlueMeter.WPF.Views.ReplayWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:b="http://schemas.microsoft.com/xaml/behaviors"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:BlueMeter.WPF.ViewModels"
    xmlns:ctrl="clr-namespace:BlueMeter.WPF.Controls"
    Title="{Binding EncounterTitle}"
    Width="1400"
    Height="800"
    MinWidth="1000"
    MinHeight="600"
    Style="{StaticResource TransparentWindow}"
    d:DataContext="{d:DesignInstance Type=vm:ReplayWindowViewModel}"
    mc:Ignorable="d">

    <WindowChrome.WindowChrome>
        <WindowChrome
            CaptionHeight="0"
            GlassFrameThickness="0"
            ResizeBorderThickness="6"
            UseAeroCaptionButtons="False" />
    </WindowChrome.WindowChrome>

    <Border Style="{StaticResource ShadowWindowBorder}" Background="#ECEBE9">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="*" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Header -->
            <ctrl:Header Title="Combat Replay" Grid.Row="0" />

            <!-- Playback Controls -->
            <Border Grid.Row="1" Background="#2297F4" Padding="15">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <!-- Left: Play/Pause/Stop Buttons -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal">
                        <Button
                            Content="â–¶ï¸ Play"
                            Command="{Binding PlayCommand}"
                            Style="{StaticResource AntButtonStyle}"
                            Padding="15,8"
                            Foreground="White"
                            Background="#52C41A"
                            BorderThickness="0"
                            IsEnabled="{Binding IsPlaying, Converter={StaticResource InvertBoolConverter}}" />
                        <Button
                            Margin="10,0,0,0"
                            Content="â¸ï¸ Pause"
                            Command="{Binding PauseCommand}"
                            Style="{StaticResource AntButtonStyle}"
                            Padding="15,8"
                            Foreground="White"
                            Background="#FFA500"
                            BorderThickness="0"
                            IsEnabled="{Binding IsPlaying}" />
                        <Button
                            Margin="10,0,0,0"
                            Content="â¹ï¸ Stop"
                            Command="{Binding StopCommand}"
                            Style="{StaticResource AntButtonStyle}"
                            Padding="15,8"
                            Foreground="White"
                            Background="#FF4D4F"
                            BorderThickness="0" />

                        <!-- Speed Control -->
                        <TextBlock
                            Margin="20,0,8,0"
                            Text="Speed:"
                            Foreground="White"
                            FontWeight="Bold"
                            VerticalAlignment="Center" />
                        <ComboBox
                            Width="80"
                            SelectedValue="{Binding PlaybackSpeed}"
                            Style="{StaticResource FieldComboBox}"
                            VerticalAlignment="Center">
                            <ComboBoxItem Content="0.5x" Tag="0.5" />
                            <ComboBoxItem Content="1x" Tag="1" IsSelected="True" />
                            <ComboBoxItem Content="2x" Tag="2" />
                            <ComboBoxItem Content="4x" Tag="4" />
                            <ComboBoxItem Content="8x" Tag="8" />
                        </ComboBox>
                    </StackPanel>

                    <!-- Center: Time Display -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <TextBlock
                            Text="{Binding CurrentTimeText}"
                            Foreground="White"
                            FontSize="24"
                            FontWeight="Bold"
                            FontFamily="Consolas" />
                        <TextBlock
                            Margin="8,0"
                            Text="/"
                            Foreground="White"
                            FontSize="20" />
                        <TextBlock
                            Text="{Binding TotalDurationText}"
                            Foreground="White"
                            FontSize="18"
                            FontFamily="Consolas" />
                    </StackPanel>

                    <!-- Right: Event Count -->
                    <TextBlock
                        Grid.Column="2"
                        Foreground="White"
                        FontSize="13"
                        VerticalAlignment="Center">
                        <Run Text="{Binding FilteredEventCount, Mode=OneWay}" FontWeight="Bold" />
                        <Run Text="/" />
                        <Run Text="{Binding TotalEvents, Mode=OneWay}" />
                        <Run Text=" events" />
                    </TextBlock>
                </Grid>
            </Border>

            <!-- Timeline Slider -->
            <Border Grid.Row="2" Padding="15,10" Background="#F5F5F5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <!-- Slider -->
                    <Slider
                        Grid.Row="0"
                        Minimum="0"
                        Maximum="{Binding TotalDuration}"
                        Value="{Binding CurrentTime, Mode=TwoWay}"
                        TickFrequency="1000"
                        IsSnapToTickEnabled="False"
                        Height="30"
                        Margin="0,0,0,10" />

                    <!-- Content Area -->
                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="250" />
                            <ColumnDefinition Width="*" />
                        </Grid.ColumnDefinitions>

                        <!-- Filters Panel -->
                        <Border Grid.Column="0" Background="White" BorderBrush="#E5E5E5" BorderThickness="0,0,1,0" Padding="10">
                            <StackPanel>
                                <TextBlock Text="Filters" FontWeight="Bold" FontSize="14" Margin="0,0,0,10" />

                                <CheckBox Content="Damage Events" IsChecked="{Binding FilterDamageEvents}" Margin="0,5" />
                                <CheckBox Content="Heal Events" IsChecked="{Binding FilterHealEvents}" Margin="0,5" />
                                <CheckBox Content="Critical Only" IsChecked="{Binding FilterCriticalOnly}" Margin="0,5" />

                                <Separator Margin="0,10" />

                                <CheckBox Content="Filter by Player" IsChecked="{Binding FilterPlayerOnly}" Margin="0,5" />
                                <ComboBox
                                    Margin="0,5"
                                    ItemsSource="{Binding AvailablePlayers}"
                                    SelectedValue="{Binding SelectedPlayerId}"
                                    SelectedValuePath="PlayerId"
                                    DisplayMemberPath="PlayerName"
                                    IsEnabled="{Binding FilterPlayerOnly}" />

                                <Separator Margin="0,10" />

                                <Button
                                    Content="ðŸ“Š Export Events"
                                    Command="{Binding ExportEventsCommand}"
                                    Style="{StaticResource AntButtonStyle}"
                                    Padding="10,6"
                                    Margin="0,5"
                                    Background="#52C41A"
                                    Foreground="White"
                                    BorderThickness="0" />
                            </StackPanel>
                        </Border>

                        <!-- Events DataGrid -->
                        <Border Grid.Column="1" Background="White" Padding="10">
                            <DataGrid
                                ItemsSource="{Binding FilteredEvents}"
                                SelectedItem="{Binding SelectedEvent}"
                                AutoGenerateColumns="False"
                                CanUserAddRows="False"
                                CanUserDeleteRows="False"
                                IsReadOnly="True"
                                SelectionMode="Single"
                                HeadersVisibility="Column"
                                GridLinesVisibility="Horizontal"
                                HorizontalGridLinesBrush="#E5E5E5"
                                RowHeight="32"
                                AlternatingRowBackground="#F9F9F9">

                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="Time" Binding="{Binding TimeText}" Width="80">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="FontFamily" Value="Consolas" />
                                                <Setter Property="FontSize" Value="11" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Type" Binding="{Binding EventType}" Width="80" />
                                    <DataGridTextColumn Header="Attacker" Binding="{Binding AttackerName}" Width="150" />
                                    <DataGridTextColumn Header="Target" Binding="{Binding TargetName}" Width="150" />
                                    <DataGridTextColumn Header="Value" Binding="{Binding ValueText}" Width="90">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="TextAlignment" Value="Right" />
                                                <Setter Property="FontWeight" Value="Bold" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Crit" Binding="{Binding CriticalText}" Width="50">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="#FF4500" />
                                                <Setter Property="FontWeight" Value="Bold" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="Skill ID" Binding="{Binding SkillId}" Width="*">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="FontFamily" Value="Consolas" />
                                                <Setter Property="FontSize" Value="10" />
                                                <Setter Property="Foreground" Value="#888" />
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                </DataGrid.Columns>

                                <DataGrid.Resources>
                                    <Style TargetType="DataGridColumnHeader">
                                        <Setter Property="Background" Value="#F5F5F5" />
                                        <Setter Property="Foreground" Value="#333" />
                                        <Setter Property="FontWeight" Value="Bold" />
                                        <Setter Property="Padding" Value="10,8" />
                                        <Setter Property="BorderBrush" Value="#E5E5E5" />
                                        <Setter Property="BorderThickness" Value="0,0,1,1" />
                                    </Style>
                                </DataGrid.Resources>
                            </DataGrid>
                        </Border>
                    </Grid>
                </Grid>
            </Border>

            <!-- Status Bar -->
            <Border Grid.Row="3" Background="#F5F5F5" BorderBrush="#E5E5E5" BorderThickness="0,1,0,0" Padding="15,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <TextBlock
                        Grid.Column="0"
                        Text="{Binding StatusText}"
                        VerticalAlignment="Center"
                        Foreground="#666" />

                    <ProgressBar
                        Grid.Column="1"
                        Width="200"
                        Height="20"
                        IsIndeterminate="True"
                        Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}" />
                </Grid>
            </Border>

            <!-- Footer -->
            <Border Grid.Row="4" Height="50" Background="#F5F5F5" BorderBrush="#E5E5E5" BorderThickness="0,1,0,0">
                <Grid Margin="15,0">
                    <Button
                        Content="Close"
                        Command="{Binding CloseCommand}"
                        Style="{StaticResource AntButtonStyle}"
                        Padding="20,8"
                        HorizontalAlignment="Right" />
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
