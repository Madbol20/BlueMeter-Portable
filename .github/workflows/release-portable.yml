name: Build Portable Folder Release

on:
  workflow_dispatch:
  push:
    branches:
      - "**"

permissions:
  contents: write

jobs:
  build-portable:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      # ------------------------------------------------------------
      # Read version from setup/Installer.iss (same as your BAT)
      # ------------------------------------------------------------
      - name: Read version from Installer.iss
        shell: pwsh
        run: |
          $matches = Select-String -Path "setup/Installer.iss" -Pattern '#define\s+MyAppVersion'
      
          if (-not $matches) {
            Write-Error "MyAppVersion not found in setup/Installer.iss"
            exit 1
          }
      
          # Take the first match explicitly
          $line = $matches[0].Line
      
          if ($line -match '#define\s+MyAppVersion\s+"([^"]+)"') {
            $version = $matches = $Matches[1]
          } else {
            Write-Error "Failed to parse version from line: $line"
            exit 1
          }

          echo "VERSION=$version" >> $env:GITHUB_ENV
          Write-Host "Version detected: $version"


      # ------------------------------------------------------------
      - name: Restore dependencies
        run: dotnet restore

      # ------------------------------------------------------------
      # Publish portable folder (NOT single-file)
      # ------------------------------------------------------------
      - name: Publish portable build
        run: >
          dotnet publish BlueMeter.WPF/BlueMeter.WPF.csproj
          -c Release
          -r win-x64
          --self-contained true
          -p:PublishSingleFile=false
          -p:DebugType=None
          -p:DebugSymbols=false
          -o release-portable/BlueMeter-v${{ env.VERSION }}-portable

      # ------------------------------------------------------------
      # Create portable launcher (.bat)
      # ------------------------------------------------------------
      - name: Create portable launcher
        shell: pwsh
        run: |
          $bat = @'
          @echo off
          cd /d "%~dp0"
          start "" "BlueMeter.WPF.exe"
          exit
          '@

          $bat | Out-File -Encoding ASCII `
            "release-portable/BlueMeter-v${{ env.VERSION }}-portable/BlueMeter.bat"

      # ------------------------------------------------------------
      # Copy README.md
      # ------------------------------------------------------------
      - name: Copy README
        shell: pwsh
        run: |
          if (Test-Path "README.md") {
            Copy-Item "README.md" `
              "release-portable/BlueMeter-v${{ env.VERSION }}-portable/README.md"
          }

      # ------------------------------------------------------------
      # Create PORTABLE-README.txt
      # ------------------------------------------------------------
      - name: Create portable README
        shell: pwsh
        run: |
          @'
          # BlueMeter Portable Edition

          This is a pre-built, portable version of BlueMeter.
          No build tools or .NET installation required.

          ## Requirements
          - Npcap (for packet capture)
            https://npcap.com/#download

          ## How to Run
          1. Install Npcap
          2. Double-click BlueMeter.bat

          ## Offline / VM Usage
          - Works fully offline
          - Copy the entire folder to another machine or VM
          - Run BlueMeter.bat

          ## Troubleshooting
          - Try running BlueMeter.WPF.exe as administrator
          - Check Windows Defender / SmartScreen
          - Ensure Npcap is installed

          For full documentation see README.md
          '@ | Out-File -Encoding UTF8 `
            "release-portable/BlueMeter-v${{ env.VERSION }}-portable/PORTABLE-README.txt"

      # ------------------------------------------------------------
      # ZIP entire portable folder
      # ------------------------------------------------------------
      - name: Create ZIP archive
        shell: pwsh
        run: |
          Compress-Archive `
            -Path "release-portable/BlueMeter-v${{ env.VERSION }}-portable" `
            -DestinationPath "release-portable/BlueMeter-v${{ env.VERSION }}-portable.zip" `
            -Force

      # ------------------------------------------------------------
      # GitHub Release
      # ------------------------------------------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: BlueMeter v${{ env.VERSION }} (Portable)
          body: |
            ## üü¶ BlueMeter Portable Folder Release

            **Version:** `${{ env.VERSION }}`
            **Runtime:** Self-contained (.NET included)
            **Type:** Folder-based portable build

            ### ‚ñ∂Ô∏è How to Run
            1. Install **Npcap**
            2. Extract the ZIP
            3. Run `BlueMeter.bat`

            ### üì¶ Included
            - Full portable folder
            - Portable launcher
            - Offline-ready
            - No installer
            - No registry writes

            ‚ö†Ô∏è Executable is unsigned ‚Äî Windows SmartScreen may warn.
          files: |
            release-portable/BlueMeter-v${{ env.VERSION }}-portable.zip

